# ラベルクリーンアップ＆明日朝の自動同期セットアップ

## 🎯 実行プラン

1. 既存トリガーの確認・整理
2. HALLELラベルの完全削除
3. 明日朝6時の自動実行トリガー設定

---

## 📝 実行手順

### ステップ1: 既存トリガーの確認

**GASエディタで実行:**

```javascript
// トリガー一覧を確認
listAllTriggers()
```

**出力例:**
```
📋 現在のトリガー一覧
============================================================

1. scheduledSync
   イベント: CLOCK
   種類: 時間ベース
   一意のID: 12345...

2. continueProcessing
   イベント: CLOCK
   種類: 時間ベース
   一意のID: 67890...

============================================================
合計: 2個のトリガー
```

---

### ステップ2: 不要なトリガーを削除

**オプションA: 全トリガー削除（推奨）**

```javascript
deleteAllTriggers()
```

**オプションB: scheduledSync のみ削除**

```javascript
deleteScheduledSyncTriggers()
```

**オプションC: continueProcessing のみ削除**

```javascript
deleteContinueProcessingTriggers()
```

**実行結果:**
```
🗑️ 全トリガー削除開始...
削除中: scheduledSync
削除中: continueProcessing

✅ 2個のトリガーを削除しました
```

---

### ステップ3: HALLELラベルの確認

```javascript
// 現在のラベルを確認
listHallelLabels()
```

**出力例:**
```
📋 HALLELラベル一覧
============================================================
1. HALLEL/Processed (スレッド数: 多数)
2. HALLEL/Booking (スレッド数: 多数)
3. HALLEL/Cancellation (スレッド数: 多数)
4. HALLEL/Shibuya (スレッド数: 多数)
5. HALLEL/YoyogiUehara (スレッド数: 多数)
6. HALLEL/Nakameguro (スレッド数: 多数)
7. HALLEL/Ebisu (スレッド数: 多数)
8. HALLEL/Hanzomon (スレッド数: 多数)

============================================================
合計: 8個のHALLELラベル
```

---

### ステップ4: HALLELラベルの完全削除

**⚠️ 重要: メールは削除されません。ラベルのみ削除されます。**

**方法1: 完全クリーンアップ（推奨）**

メールからラベルを解除してから削除する最も安全な方法：

```javascript
fullCleanupHallelLabels()
```

**実行結果:**
```
🧹 HALLEL完全クリーンアップ開始...
============================================================

ステップ1: メールからラベルを解除
🏷️ 全メールからHALLELラベルを解除中...
⚠️ ラベルのみ解除されます。メールは削除されません。
============================================================

処理中: HALLEL/Processed
  100件のスレッドからラベル解除...
  200件のスレッドからラベル解除...
  ✅ HALLEL/Processed: 250件処理完了

処理中: HALLEL/Booking
  ✅ HALLEL/Booking: 200件処理完了

...

✅ 合計 1500件のスレッドからラベルを解除しました

============================================================

ステップ2: ラベルを削除
🗑️ HALLELラベル一括削除開始...
削除中: HALLEL/Processed
  ✅ 削除完了
削除中: HALLEL/Booking
  ✅ 削除完了
...

✅ 8個のラベルを削除しました

============================================================
✅ 完全クリーンアップ完了
```

**方法2: ラベルのみ削除（速い）**

メールからラベルを解除せずに削除：

```javascript
deleteAllHallelLabels()
```

---

### ステップ5: 明日朝の自動実行トリガー設定

```javascript
setupTomorrowMorningSync()
```

**実行結果:**
```
⏰ 明日朝の全件同期トリガー設定
============================================================
✅ トリガー設定完了
実行予定: 2024年11月08日 06:00
関数: forceFullSync

💡 明日の朝6時に自動的に全件同期が開始されます
```

---

### ステップ6: トリガー設定の確認

```javascript
checkScheduledTriggers()
```

**実行結果:**
```
📋 設定済みトリガー確認
============================================================

1. forceFullSync
   イベント: CLOCK
   トリガーID: abc123...

============================================================
合計: 1個のトリガー
```

---

## 🎬 実行順序（クイックスタート）

GASエディタで順番に実行：

```javascript
// 1. 既存トリガーを全削除
deleteAllTriggers()

// 2. HALLELラベルを完全クリーンアップ
fullCleanupHallelLabels()

// 3. 明日朝6時の自動実行を設定
setupTomorrowMorningSync()

// 4. 設定確認
checkScheduledTriggers()
```

**これで完了！** 🎉

---

## ⏰ カスタム時刻で実行したい場合

朝6時以外の時刻で実行したい場合：

```javascript
// 12時間後に実行
setupCustomTimeSync(12)

// 24時間後に実行
setupCustomTimeSync(24)

// 8時間後に実行
setupCustomTimeSync(8)
```

---

## 🔄 トリガーをキャンセルしたい場合

```javascript
// 明日の同期をキャンセル
cancelTomorrowSync()
```

---

## 📊 明日の朝、実行結果を確認する方法

### 方法1: GASのログを確認

1. GASエディタを開く
2. 「実行」タブを開く
3. 最新の実行ログを確認

**成功例:**
```
✅ 全バッチ処理完了: 523件の予約を処理
```

### 方法2: Gmailでラベルを確認

新しく作成された `HALLEL/` ラベルを確認：
```
HALLEL/
├── Processed (523)  ← この数字が処理件数
├── Booking (450)
└── Shibuya (200)
```

### 方法3: Vercelで確認

https://hallelshibuyabooking.vercel.app/admin

全店舗の予約が反映されているか確認

---

## ⚠️ トラブルシューティング

### ラベル削除で "Service invoked too many times" エラー

**原因:** 今日の制限に達している

**対処:**
1. 明日まで待つ
2. または手動でGmailからラベルを削除：
   - Gmailを開く
   - 左サイドバーの `HALLEL/` を右クリック
   - 「ラベルを削除」をクリック
   - 各ラベルを順番に削除

### トリガーが実行されない

**確認:**
```javascript
checkScheduledTriggers()
```

トリガーが表示されれば設定されています。

**実行されない場合:**
- GASエディタの「実行」タブでエラーを確認
- 権限が承認されているか確認

### 朝起きても処理が完了していない

**確認方法:**
```javascript
checkProgress()
```

**継続中の場合:**
- バッチ処理が続行中
- 1時間ほど待つ

**エラーの場合:**
- GASログでエラー内容を確認
- 手動で `forceFullSync()` を再実行

---

## 💡 ヒント

### ラベル削除は本当に必要？

もしラベルが正しく付いているなら、削除せずにそのままでもOKです。
ただし、以下の場合は削除を推奨：

- ✅ 重複ラベルがある
- ✅ 古いラベルを整理したい
- ✅ 一からやり直したい

### トリガーの実行時刻を変更したい

```javascript
// 一度キャンセル
cancelTomorrowSync()

// 希望の時間で再設定
setupCustomTimeSync(10)  // 10時間後
```

---

## ✅ 完了チェックリスト

実行前：
- [ ] 既存トリガーを確認した
- [ ] 不要なトリガーを削除した
- [ ] HALLELラベルを削除した（または確認した）
- [ ] 明日朝のトリガーを設定した
- [ ] トリガー設定を確認した

翌朝：
- [ ] GASログで完了を確認
- [ ] Gmailでラベルを確認
- [ ] Vercelで予約データを確認

---

**最終更新:** 2024-11-07
