# HALLEL 渋谷店 予約管理システム

HALLEL渋谷店の予約状況を管理・表示するWebアプリケーションです。

## 📋 機能

### 🌐 公開ページ
- リアルタイムの予約状況確認
- 30分単位のタイムスロット表示
- カレンダーで日付切り替え
- ダークテーマのスタイリッシュなデザイン
- レスポンシブ対応（スマホ・PC）

### 🔐 管理者機能
- 管理者ログイン認証
- 予約の手動追加・削除
- 貸切予約の管理
- アクティビティログの閲覧
- パスワード変更機能

### 📧 Gmail自動連携
- Gmailから予約メールを自動検知
- 予約・キャンセルの自動反映
- **メール数過多対策実装済み**
  - 日付・キーワードフィルタリング
  - 処理件数制限
  - ラベル使用を最小化

## 🚀 クイックスタート

### 1. 必要なソフトウェア

- Python 3.8以上
- pip

### 2. インストール

```bash
# リポジトリのクローン
git clone https://github.com/yourusername/HALLEL-.git
cd HALLEL-

# 依存パッケージのインストール
pip install -r requirements.txt
```

### 3. アプリケーションの起動

```bash
python app.py
```

アプリケーションは http://localhost:5001 で起動します。

### 4. 初期ログイン

- URL: http://localhost:5001/login
- 初期パスワード: `hallel0000admin`

**重要: 初回ログイン後、必ずパスワードを変更してください！**

## 📁 ファイル構成

```
HALLEL-/
├── app.py                      # メインアプリケーション
├── requirements.txt            # Python依存パッケージ
├── password.txt                # 管理者パスワード（ハッシュ化）
├── activity.log                # アクティビティログ
│
├── templates/                  # HTMLテンプレート
│   ├── booking-status.html     # 公開予約状況ページ
│   ├── admin.html              # 管理ダッシュボード
│   ├── admin-calendar.html     # カレンダー管理
│   └── login.html              # ログインページ
│
├── gmail_booking_sync.py       # Gmail連携スクリプト（Python版）
├── google-apps-script.js       # Gmail連携スクリプト（GAS版）
├── get_gmail_token.py          # Gmail認証トークン取得
│
├── config.example.py           # 設定ファイルの例
├── README.md                   # このファイル
└── GMAIL_SETUP.md              # Gmail連携セットアップガイド
```

## 📧 Gmail連携のセットアップ

Gmail連携を使用すると、予約メールを自動的に検知してシステムに反映できます。

詳しいセットアップ方法は **[GMAIL_SETUP.md](GMAIL_SETUP.md)** を参照してください。

### メール数過多問題について

Gmail APIでは、大量のメールにラベルを付けようとするとAPIの制限に引っかかります。
本システムでは以下の対策を実装しています：

- ✅ 過去7日間のメールのみ対象
- ✅ 未読メールのみ処理
- ✅ 件名キーワードでフィルタリング
- ✅ 一度に最大50件まで処理
- ✅ ラベル不使用（既読マークのみ）

詳細は [GMAIL_SETUP.md](GMAIL_SETUP.md) の「メール数過多対策について」を参照。

## 🎨 画面説明

### 公開ページ（/）
一般客が予約状況を確認できるページです。

- **緑**: 空いています（0-40%）
- **黄**: やや混雑（40-70%）
- **赤**: 混雑（70%以上）
- **グレー**: 貸切

### 管理者ページ（/admin）
ログイン後にアクセスできる管理画面です。

- アクティビティログの閲覧
- パスワード変更
- カレンダー管理へのリンク

### カレンダー管理（/admin/calendar）
予約の追加・削除を行えます。

- タイムスロットをクリックして予約追加
- 既存予約の削除
- 貸切予約の設定

## 🔧 設定

### 最大収容人数の変更

`app.py` と各HTMLファイルの `MAX_CAPACITY` を変更してください。

```python
# app.py (該当なし、HTMLファイルで設定)
```

```javascript
// templates/booking-status.html
// templates/admin-calendar.html
const MAX_CAPACITY = 7;  // ここを変更
```

### パスワードの変更

管理者画面（/admin）からパスワードを変更できます。

または、初期パスワードを変更したい場合は：

1. `password.txt` を削除
2. `app.py` の `set_initial_password()` 関数内のパスワードを変更
3. アプリケーションを再起動

## 📡 API エンドポイント

### GET /api/reservations
すべての予約データを取得します。

**レスポンス例:**
```json
{
  "2025-08-01": [
    { "type": "gmail", "start": "14:00", "end": "15:00" },
    { "type": "charter", "start": "11:00", "end": "13:00" }
  ]
}
```

### POST /api/reservations
予約を追加します（管理者のみ）。

**リクエスト例:**
```json
{
  "date": "2025-08-01",
  "type": "manual",
  "start": "16:00",
  "end": "17:00"
}
```

### POST /api/reservations/delete
予約を削除します（管理者のみ）。

**リクエスト例:**
```json
{
  "date": "2025-08-01",
  "index": 0
}
```

### POST /api/process_email
Gmail連携用のエンドポイントです（外部スクリプトから呼び出し）。

**予約の追加:**
```json
{
  "action_type": "booking",
  "date": "2025-08-05",
  "start_time": "14:00",
  "end_time": "15:30"
}
```

**予約のキャンセル:**
```json
{
  "action_type": "cancellation",
  "date": "2025-08-05",
  "start_time": "14:00"
}
```

## 🗃️ データの永続化

現在、予約データはメモリ上に保存されているため、サーバーを再起動するとデータが消えます。

### 本番環境での推奨事項

1. **データベースの導入**
   - SQLite（小規模）
   - PostgreSQL（中〜大規模）

2. **バックアップ機能の追加**
   - 定期的なデータのJSONエクスポート
   - データベースのバックアップ

3. **本番用サーバーの使用**
   - Gunicorn + Nginx
   - または、PaaSサービス（Heroku、Railway等）

## 🛡️ セキュリティ

### セキュリティ強化状況（フェーズ1-2実装済み）

✅ **フェーズ1実装済み:**
- データベースベースの認証システム
- ブルートフォース攻撃対策（5回失敗で15分ロック）
- アクティビティログ（IP・User-Agent記録）
- パスワードハッシュ化（pbkdf2:sha256）
- セッション管理の改善（環境変数SECRET_KEY）
- CSRF保護（Flask-WTF）
- セキュリティヘッダー（X-Frame-Options、CSP等）
- プライバシーポリシー・利用規約
- Cookie同意バナー（電気通信事業法対応）

✅ **フェーズ2実装済み:**
- レート制限（Flask-Limiter）- DoS攻撃対策
- Webhook認証（APIキー認証）
- パスワード強度要件強化（12文字+複雑性）
- 監査ログ強化（詳細な操作履歴）

⚠️ **今後の予定:**
- 多要素認証（MFA）
- データベース暗号化
- リアルタイムモニタリング

詳細は **[SECURITY_LEGAL_AUDIT_REPORT.md](SECURITY_LEGAL_AUDIT_REPORT.md)** を参照してください。

### 本番環境での注意点

1. **必須の環境変数**
   - `SECRET_KEY`: セッション管理用（ランダムな文字列、32文字以上推奨）
   - `POSTGRES_URL`: PostgreSQLデータベース接続URL
   - `WEBHOOK_API_KEY`: GAS Webhook認証用（省略可、推奨設定）

   Vercelでの設定方法:
   ```bash
   # Settings → Environment Variables で設定
   SECRET_KEY=your-secret-key-here
   WEBHOOK_API_KEY=your-webhook-api-key-here
   ```

2. **HTTPS の使用**
   - SSL証明書の設定
   - Vercel/Netlify等では自動設定

3. **パスワードポリシー**
   - 最低12文字以上、大文字・小文字・数字・記号を含む（実装済み）
   - 定期的な変更を推奨

4. **認証情報の管理**
   - credentials.json と token.json をGitにコミットしない
   - .gitignore に追加済み

5. **GAS Webhookの設定** ✅ 設定済み
   - `google-apps-script.js` の `CONFIG.WEBHOOK_API_KEY` にAPI keyを設定
   - `sendToFlaskAPI` 関数が自動的に `X-API-Key` ヘッダーを追加
   - 詳細は `google-apps-script.js` の16行目と171-173行目を参照

## 📋 未完了タスク一覧

### 🔴 即座対応（700名展開前に必須）

**期限**: 公開前（推定6-8営業日）

#### 1. **Gmail Push通知実装** 🚀 優先度：最高
**目的**: リアルタイム予約処理 + Gmail API制限回避

**現状の問題**:
- 現在のポーリング方式（10分ごと）でGmail API制限オーバー（1日100回制限）
- データ遅延が発生（最大10分）

**実装内容**:
- [ ] Google Cloud Project設定
- [ ] Cloud Pub/Subトピック作成
- [ ] GASコード変更（Push通知受信対応）
- [ ] 自動再登録スクリプト（7日ごとのwatch更新を自動化）

**工数**: 1-2時間（初回設定） + 30分（メンテナンス自動化）
**コスト**: 無料枠内（月10GBまで、700名展開でも問題なし）
**メンテナンス**: 自動化後は放置OK

---

#### 2. **全店舗対応（恵比寿店・半蔵門店等のGmail連携）** 📍 優先度：最高
**目的**: 全5店舗の予約をVercelに反映

**現状の問題**:
- GASスクリプトが渋谷店のメールのみ検索している
- 店舗名の抽出・送信ロジックがない
- 恵比寿店・半蔵門店・代々木上原店・中目黒店のデータが反映されない

**実装内容**:
- [ ] GAS検索キーワードに全店舗を追加
- [ ] メール本文から店舗名を抽出する関数追加
- [ ] Flask APIへの店舗名送信対応
- [ ] 全店舗の動作テスト

**工数**: 2-3時間
**影響範囲**: `google-apps-script.js`

---

#### 3. **法的文書の事業者情報更新** 📄 優先度：高
**目的**: 個人情報保護法・電気通信事業法の完全準拠

**現状の問題**:
- プライバシーポリシー・利用規約にプレースホルダーが残っている
- 事業者情報が未記入

**更新が必要な情報**:
- [ ] 代表者名: [代表者名] → 実際の名前
- [ ] 住所: [住所] → 実際の住所
- [ ] 電話番号: [電話番号] → 実際の電話番号
- [ ] メールアドレス: privacy@hallel.example.com → 実際のメール

**工数**: 10分（情報提供後）
**影響範囲**: `templates/privacy-policy.html`, `templates/terms-of-service.html`

---

#### 4. **入力検証の強化** 🔒 優先度：高
**目的**: OWASP A03 Injection対策

**現状の問題**:
- 予約API（`/api/reservations`）の日付・時刻形式検証が不十分
- 不正なデータの挿入リスク

**実装内容**:
- [ ] 日付形式バリデーション関数（YYYY-MM-DD）
- [ ] 時刻形式バリデーション関数（HH:MM）
- [ ] 全APIエンドポイントに適用
- [ ] エラーメッセージの改善

**工数**: 1-2日
**影響範囲**: `app.py`

---

#### 5. **セッション管理強化** 🔐 優先度：高
**目的**: セッション固定攻撃（Session Fixation）対策

**現状の問題**:
- ログイン成功時にセッションIDが再生成されない
- セッションタイムアウトが未設定

**実装内容**:
- [ ] ログイン成功時のセッションID再生成
- [ ] セッションタイムアウト設定（30分推奨）
- [ ] ログアウト時のセッション完全削除

**工数**: 1日
**影響範囲**: `app.py` (login関数、session設定)

---

#### 6. **データ保持ポリシー** 📅 優先度：中
**目的**: 個人情報保護法第22条対応

**現状の問題**:
- 予約データをいつまで保持するか未定義
- 古いデータの自動削除なし

**実装内容**:
- [ ] データ保持期間の決定（例：予約日から1年後）
- [ ] 自動削除バッチ処理の実装
- [ ] プライバシーポリシーへの記載
- [ ] 顧客への通知機能（オプション）

**工数**: 2日
**影響範囲**: `app.py`, `templates/privacy-policy.html`

---

#### 7. **インシデント対応計画** 🚨 優先度：中
**目的**: 個人情報保護法第26条対応（漏洩時の報告義務）

**現状の問題**:
- セキュリティ侵害時の対応手順が未定義
- データ漏洩時の報告フローがない

**実装内容**:
- [ ] インシデント対応マニュアル作成
- [ ] 個人情報保護委員会への報告手順（72時間以内）
- [ ] 顧客への通知テンプレート
- [ ] 緊急連絡先リスト
- [ ] 定期訓練スケジュール

**工数**: 2-3日
**成果物**: `INCIDENT_RESPONSE_PLAN.md`

---

### 🟡 推奨対応（公開後1-3ヶ月以内）

**期限**: 公開後1-3ヶ月（推定4営業日）

#### 8. **HTTPS強制**
- [ ] Flask側でHTTPSリダイレクト実装
**工数**: 0.5日

#### 9. **年齢制限対応**（未成年者データ取り扱い）
- [ ] 18歳未満の利用規約同意に保護者同意を追加
**工数**: 0.5日

#### 10. **特定商取引法対応**（有料サービスの場合）
- [ ] 返金ポリシー明記
- [ ] 事業者情報の追加表示
**工数**: 1日

#### 11. **依存パッケージ脆弱性スキャン**
- [ ] `pip-audit` または `safety` の導入
- [ ] GitHub Actions自動スキャン設定
**工数**: 1日

---

### 🟢 将来の機能拡張（優先度低）

**期限**: 公開後3ヶ月以降

#### 認証・セキュリティ
- [ ] **複数管理者アカウント対応** - ログインユーザーの完全な区別（誰がログインしたか識別）
- [ ] 多要素認証（MFA）
- [ ] 管理者の権限レベル設定（閲覧のみ、編集可能など）
- [ ] ログイン履歴の詳細表示

#### 機能拡張
- [ ] 予約のメール通知
- [ ] 顧客データベース（顧客情報の蓄積）
- [ ] レポート機能（月次利用統計など）
- [ ] API認証トークン（外部システム連携用）

#### インフラ
- [ ] データベース暗号化
- [ ] リアルタイムモニタリング
- [ ] 自動バックアップ

## 🐛 トラブルシューティング

### アプリが起動しない

**原因:** ポート5001が使用中

```bash
# 別のポートで起動
python app.py
# app.py内のポート番号を変更
```

### ログインできない

1. `password.txt` を削除
2. アプリケーションを再起動
3. 初期パスワード `hallel0000admin` でログイン

### Gmail連携がうまく動かない

[GMAIL_SETUP.md](GMAIL_SETUP.md) の「トラブルシューティング」を参照してください。

## 📝 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🤝 コントリビューション

バグ報告や機能追加の提案は、GitHubのIssueからお願いします。

## 📞 サポート

質問や問題がある場合は、以下の方法でお問い合わせください：

- GitHub Issues
- Email: support@hallel.example.com

---

**HALLEL 渋谷店 予約管理システム**
Made with ❤️ for HALLEL
