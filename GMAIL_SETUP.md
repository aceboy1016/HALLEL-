# Gmail連携セットアップガイド

HALLEL予約システムのGmail連携機能のセットアップ方法を説明します。

## 📋 目次

1. [概要](#概要)
2. [メール数過多対策について](#メール数過多対策について)
3. [Google Cloud Platformの設定](#google-cloud-platformの設定)
4. [方法1: Pythonスクリプトでの連携](#方法1-pythonスクリプトでの連携)
5. [方法2: Google Apps Scriptでの連携](#方法2-google-apps-scriptでの連携)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

Gmail連携機能により、予約メールを自動的に検知して予約システムに反映できます。

### サポートするメールフォーマット

**予約メール:**
```
予約: 2025-08-05 14:00-15:30
お客様名: 田中太郎
```

**キャンセルメール:**
```
キャンセル: 2025-08-05 14:00
お客様名: 佐藤花子
```

---

## メール数過多対策について

### 問題点
大量のメールにラベルを付けようとすると、Gmail APIの制限に引っかかりシステムがパンクする可能性があります。

### 実装した対策

1. **日付フィルタリング**
   - 過去7日間のメールのみを対象にする
   - 古いメールは処理対象外

2. **未読メール限定**
   - 未読メールのみを処理対象にする
   - 処理済みは既読マークで判定

3. **件名フィルタリング**
   - 「予約」「キャンセル」などのキーワードを含むメールのみ
   - 不要なメールを事前に除外

4. **処理件数制限**
   - 一度の実行で最大50件まで処理
   - 大量のメールを段階的に処理

5. **ラベル最小化**
   - 既読マークのみ使用（ラベルは付けない）
   - Gmail APIの負荷を軽減

### カスタマイズ方法

`gmail_booking_sync.py` の設定を変更:

```python
MAX_EMAILS_PER_RUN = 50  # 処理件数を増減
DAYS_TO_SEARCH = 7       # 検索範囲を変更
SEARCH_KEYWORDS = ['予約', 'キャンセル', 'HALLEL']  # キーワード追加
```

---

## Google Cloud Platformの設定

### 1. プロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成（例: hallel-booking-system）

### 2. Gmail APIの有効化

1. 「APIとサービス」→「ライブラリ」
2. "Gmail API" を検索して有効化

### 3. OAuth 2.0認証情報の作成

1. 「APIとサービス」→「認証情報」
2. 「認証情報を作成」→「OAuthクライアントID」
3. アプリケーションの種類: **デスクトップアプリ**
4. 名前: 任意（例: HALLEL Desktop Client）
5. 作成後、JSONをダウンロード
6. ダウンロードしたファイルを `credentials.json` にリネーム
7. プロジェクトルートに配置

### 4. テストユーザーの追加

1. 「OAuth同意画面」を設定
2. テストユーザーに予約メールを受信するGmailアドレスを追加

---

## 方法1: Pythonスクリプトでの連携

### セットアップ

1. **依存パッケージのインストール**

```bash
pip install -r requirements.txt
```

2. **認証トークンの取得**

```bash
python get_gmail_token.py
```

ブラウザが開くので、Googleアカウントでログインして認証します。
成功すると `token.json` が生成されます。

### 実行方法

**手動実行:**

```bash
python gmail_booking_sync.py
```

**定期実行（cron）:**

Linuxの場合、crontabに追加:

```bash
crontab -e
```

10分ごとに実行する例:
```
*/10 * * * * cd /path/to/HALLEL- && python3 gmail_booking_sync.py >> logs/gmail_sync.log 2>&1
```

**定期実行（Windows）:**

タスクスケジューラを使用して10分ごとに実行するように設定します。

### 実行例

```
============================================================
HALLEL Gmail連携 - 予約同期開始
============================================================
検索クエリ: is:unread after:2025/10/30 (subject:予約 OR subject:キャンセル OR subject:HALLEL OR subject:渋谷店)
最大処理件数: 50
------------------------------------------------------------
処理対象メール数: 3件
------------------------------------------------------------

[1/3] メールID: 18c1234567890abc
  アクション: booking
  日付: 2025-08-05
  開始: 14:00
  終了: 15:30
  ✓ APIに送信成功: {'status': 'success', 'message': '予約を追加しました: 2025-08-05 14:00 - 15:30'}

============================================================
処理完了
成功: 2件 / エラー: 0件 / スキップ: 1件
============================================================
```

---

## 方法2: Google Apps Scriptでの連携

GASはサーバーレスで動作し、定期実行に最適です。

### セットアップ

1. **GASプロジェクトの作成**

   - https://script.google.com/ にアクセス
   - 「新しいプロジェクト」をクリック

2. **コードの貼り付け**

   `google-apps-script.js` の内容をコピーしてGASエディタに貼り付け

3. **設定の変更**

   ```javascript
   const CONFIG = {
     FLASK_API_URL: 'https://your-actual-domain.com/api/process_email',  // 実際のURLに変更
     MAX_EMAILS_PER_RUN: 50,
     DAYS_TO_SEARCH: 7,
     SEARCH_KEYWORDS: ['予約', 'キャンセル', 'HALLEL', '渋谷店']
   };
   ```

4. **トリガーの設定**

   - GASエディタで「トリガー」アイコン（時計マーク）をクリック
   - 「トリガーを追加」
   - 実行する関数: `processHallelBookingEmails`
   - イベントのソース: 時間主導型
   - 時間ベースのトリガー: 分ベースのタイマー
   - 時間の間隔: 10分おき

5. **初回実行と認証**

   - 「実行」ボタンをクリック
   - Googleアカウントでの認証を許可

### テスト用関数

**設定の確認:**
```javascript
testConfig()  // 実行してログを確認
```

**パース機能のテスト:**
```javascript
testParsing()  // 実行してログを確認
```

---

## トラブルシューティング

### メールが処理されない

**原因1: 検索クエリにヒットしていない**
- 件名に「予約」「キャンセル」などのキーワードが含まれているか確認
- `SEARCH_KEYWORDS` の設定を確認

**原因2: メール本文のフォーマットが違う**
- メール本文が以下の形式になっているか確認:
  - `予約: 2025-08-05 14:00-15:30`
  - `キャンセル: 2025-08-05 14:00`

**原因3: すでに既読になっている**
- スクリプトは未読メールのみを処理します
- 手動で未読に戻してから再実行してみてください

### API エラー 401 Unauthorized

- `token.json` を削除して再認証
- `credentials.json` が正しい場所にあるか確認

### API エラー 404 Not Found

- Flask APIのURLが正しいか確認
- Flaskアプリが起動しているか確認

### メール数が多すぎてタイムアウト

- `MAX_EMAILS_PER_RUN` を減らす（例: 20）
- 実行頻度を上げる（例: 5分ごと）

### GASの実行時間制限エラー

GASには6分の実行時間制限があります。

**対策:**
- `MAX_EMAILS_PER_RUN` を減らす
- トリガーの頻度を上げて小分けに処理

---

## セキュリティ上の注意

1. **credentials.json の管理**
   - Gitにコミットしない（.gitignoreに追加）
   - 安全な場所に保管

2. **token.json の管理**
   - Gitにコミットしない
   - 定期的に再生成を検討

3. **API URLの公開設定**
   - 本番環境ではHTTPSを使用
   - 可能であれば、IPアドレス制限やAPIキーを追加

---

## よくある質問

**Q: Python版とGAS版、どちらを使うべき？**

A:
- **Python版**: サーバーで定期実行する場合、ログが詳細
- **GAS版**: サーバーレス、セットアップが簡単、無料で定期実行

**Q: ラベルは全く使わないの？**

A: はい、既読/未読のみで管理します。ラベル付けが必要な場合は、処理成功後に特定のラベルを付けるコードを追加できますが、メール数が多い場合は推奨しません。

**Q: メールフォーマットをカスタマイズできる？**

A: はい、`parse_email_body` 関数の正規表現を変更することで対応できます。

---

## サポート

問題が解決しない場合は、以下の情報を含めてお問い合わせください：

1. エラーメッセージの全文
2. 実行ログ
3. メール本文のサンプル（個人情報を除く）
4. 使用している方法（Python版 or GAS版）
